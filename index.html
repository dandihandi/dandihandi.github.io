<!DOCTYPE html>

<html lang="pl">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%236366f1%22/><circle cx=%2250%22 cy=%2250%22 r=%2225%22 fill=%22none%22 stroke=%22white%22 stroke-width=%228%22/><circle cx=%2250%22 cy=%2250%22 r=%228%22 fill=%22white%22/></svg>">
<meta charset="utf-8"/>
<title>SMASH YOUR GOALS – Planner</title>
<style>
        :root {
            --bg-dark: #0f172a;
            --bg-gradient: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 70%);
            --glass-surface: rgba(30, 41, 59, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(12px);
            
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --radius-lg: 16px;
            --radius-md: 10px;
            --radius-sm: 6px;
            
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-dark);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .wrapper {
            max-width: 1320px;
            width: 96%;
            margin: 0 auto;
            padding: 32px 0 60px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            flex-wrap: wrap;
            gap: 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        
        .brand-logo {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.5);
            overflow: hidden;
        }
        .brand-logo::before {
            content: "";
            position: absolute;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            top: -20%;
            left: -20%;
        }
        .brand-logo svg {
            width: 24px;
            height: 24px;
            color: white;
            z-index: 1;
        }

        

        .brand-text h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .brand-text span {
            font-size: 13px;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 6px 14px 6px 8px;
            border-radius: 50px;
        }
        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }
        .user-name-wrap {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        .user-name { font-size: 14px; font-weight: 600; }
        .user-sub { font-size: 11px; color: var(--text-muted); }

        button {
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
        }
        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-icon {
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-outline-light {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 500;
        }
        .btn-outline-light:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: white;
        }

        .period-chip {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
        }
        .period-chip label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .period-chip input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            font-size: 14px;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        .period-chip input:focus {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .period-tag {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
        }

        .layout {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 24px;
            align-items: start;
        }
        @media (max-width: 1100px) { .layout { grid-template-columns: 1fr; } }
        @media (max-width: 700px) { 
            .topbar { flex-direction: column; align-items: stretch; }
            .topbar-right { justify-content: space-between; }
        }

        .card {
            background: var(--glass-surface);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--shadow-card);
            margin-bottom: 24px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 16px;
        }
        .card-header h2 {
            margin: 0 0 6px 0;
            font-size: 20px;
            font-weight: 600;
        }
        .card-header span {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        th {
            text-align: left;
            padding: 0 16px 10px;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        td {
            background: rgba(20, 25, 40, 0.6);
            padding: 12px 16px;
            vertical-align: middle;
            border-top: 1px solid var(--glass-border);
            border-bottom: 1px solid var(--glass-border);
        }
        td:first-child {
            border-left: 1px solid var(--glass-border);
            border-top-left-radius: var(--radius-md);
            border-bottom-left-radius: var(--radius-md);
        }
        td:last-child {
            border-right: 1px solid var(--glass-border);
            border-top-right-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
        }

        input[type="text"], select {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-main);
            width: 100%;
            padding: 8px;
            font-size: 14px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }
        input[type="text"]:hover, select:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        input[type="text"]:focus, select:focus {
            background: rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        input::placeholder { color: rgba(148, 163, 184, 0.5); }
        
        select { cursor: pointer; background-image: none; }
        option { background: #1e293b; color: white; }

        .status-icon-btn {
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            transition: transform 0.2s;
        }
        .status-icon-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
        }

        @keyframes spin-hourglass {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(180deg); }
        }
        .icon-spin {
            /* animation: spin-hourglass 2s infinite ease-in-out; */
            transform-origin: center;
        }

        .goals-footer { margin-top: 8px; display: flex; justify-content: center !important; align-items: center; padding-top: 5px; }
        .muted { color: var(--text-muted); font-size: 13px; }

        .weeks-card {
            margin-top: 32px !important;
            background: rgba(15, 23, 42, 0.3) !important;
            border: 1px solid var(--glass-border) !important;
            border-radius: var(--radius-lg) !important;
            padding: 24px !important;
        }
        .weeks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .week-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 16px;
            transition: transform 0.2s;
        }
        .week-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .week-row-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 13px;
        }
        .badge-week {
            font-weight: 700;
            color: var(--primary);
        }
        .week-date { color: var(--text-muted); }

        .week-toggles {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: rgba(0,0,0,0.2);
            padding: 4px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
        }
        .week-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-muted);
            padding: 6px;
            border-radius: 4px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .week-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
        }
        .week-btn.btn-success.active {
            background: var(--success);
            color: #064e3b;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }
        .week-btn.btn-fail.active {
            background: var(--danger);
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        .week-note {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-main);
            padding: 8px;
            font-size: 13px;
            resize: vertical;
            min-height: 60px;
            margin-bottom: 10px;
        }
        .week-note:focus {
            border-color: var(--primary);
        }

        .week-rating {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }
        .week-rating-input {
            width: 70px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: var(--radius-sm);
            padding: 4px 8px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            gap: 16px;
        }
        .stat {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .stat-success { color: var(--success); text-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .stat-extra { font-size: 12px; color: var(--text-muted); opacity: 0.7; line-height: 1.4; }

        .penalty-amount-highlight {
            color: #ef4444;
            font-weight: 800;
            font-size: 1.1em;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        #authModal, #profileOverlay, #penaltyModal {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .auth-card, .profile-overlay-inner, #penaltyModalInner {
            background: #1e293b;
            border: 1px solid var(--glass-border);
            padding: 32px;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .profiles-grid, .profiles-grid-overlay {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        .profile-tile {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .profile-tile:hover { background: rgba(255,255,255,0.1); }
        .profile-tile.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .profile-avatar {
            width: 32px; height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-bottom: 6px;
        }
        .profile-name { font-size: 11px; text-align: center; overflow: hidden; text-overflow: ellipsis; width: 100%; padding: 0 4px; }
        .profile-delete {
            position: absolute; top: -6px; right: -6px;
            width: 20px; height: 20px;
            background: var(--danger); color: white;
            border-radius: 50%; border: none;
            display: none; align-items: center; justify-content: center;
            font-size: 14px; line-height: 1;
        }
        .profile-tile:hover .profile-delete { display: flex; }
    
        /* --- Status Dropdown --- */
        .status-dropdown {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 8px;
            box-shadow: var(--shadow-card);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 180px;
            backdrop-filter: blur(12px);
        }
        .status-dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            color: var(--text-main);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        .status-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- Loading Dots Animation (W TRAKCIE) --- */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
            justify-content: center;
            align-items: center;
            height: 20px; 
        }
        .loading-dots div {
            width: 5px;
            height: 5px;
            background: #94a3b8;
            border-radius: 50%;
            /* animation: bounce 1.4s infinite ease-in-out both; */
        }
        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* --- Settings Gear Animation --- */
        @keyframes spin-once {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #openAuthModal:hover svg, .btn-icon:hover svg {
            animation: spin-once 0.8s ease-in-out;
        }

        /* --- Netflix-Style Profiles (General & Settings) --- */
        .profile-tile {
            background: transparent !important;
            border: none !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
        }
        .profile-tile:hover {
            transform: scale(1.05);
        }
        .profile-avatar {
            width: 80px !important;
            height: 80px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem !important;
            font-weight: bold;
            color: white;
            border: 3px solid transparent;
            transition: border-color 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 0 !important;
        }
        .profile-tile:hover .profile-avatar {
            border-color: white;
        }
        .profile-name {
            font-size: 1rem;
            color: #94a3b8;
            transition: color 0.2s;
            text-align: center;
        }
        .profile-tile:hover .profile-name {
            color: white;
        }

        .profile-tile.overlay .profile-avatar {
            width: 120px !important;
            height: 120px !important;
            font-size: 3rem !important;
        }
        .profile-tile.overlay .profile-name {
            font-size: 1.2rem;
        }

        #profilesGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .type-icon-btn {
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            transition: transform 0.2s;
            font-weight: 500;
            letter-spacing: 0.5px;
            color: #e5e7eb;
        }
        .type-icon-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .goal-delete-btn {
            position: absolute;
            top: -8px;
            left: -3px;
            width: 22px;
            height: 22px;
            background: #ef4444;
            color: white;
            border: 2px solid var(--bg-dark);
            border-radius: 50%;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #goalsTable tr:hover .goal-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        #goalsTable td:first-child {
            position: relative; 
        }

        
        .week-card.current-week {
            border: 2px solid #ffffff !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3) !important;
            transform: scale(1.02);
            z-index: 10;
        }
        .week-card.week-success {
            background: rgba(16, 185, 129, 0.15) !important;
            border-color: var(--success) !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
        .week-card.week-fail {
            background: rgba(239, 68, 68, 0.15) !important;
            border-color: var(--danger) !important;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        tr.goal-success td {
            background: rgba(16, 185, 129, 0.15) !important;
            box-shadow: inset 0 0 10px rgba(16, 185, 129, 0.1);
        }
        tr.goal-fail td {
            background: rgba(239, 68, 68, 0.15) !important;
            box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.1);
        }
        tr.goal-partial td {
            background: rgba(245, 158, 11, 0.15) !important;
            box-shadow: inset 0 0 10px rgba(245, 158, 11, 0.1);
        }

#congratsModal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

#congratsContent {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 10% auto;
    padding: 40px;
    border-radius: 20px;
    max-width: 400px;
    text-align: center;
    color: white;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: slideDown 0.4s;
}

#congratsContent h2 {
    font-size: 2.5em;
    margin: 0 0 20px 0;
    animation: bounce 0.6s;
}

#congratsContent p {
    font-size: 1.2em;
    margin: 20px 0;
    opacity: 0.95;
}

#congratsIcon {
    font-size: 5em;
    margin: 20px 0;
    animation: scaleIn 0.5s;
}

#closeCongratsBtn {
    background-color: white;
    color: #667eea;
    border: none;
    padding: 12px 30px;
    font-size: 1.1em;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 20px;
    transition: transform 0.2s, box-shadow 0.2s;
}

#closeCongratsBtn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from { 
        transform: translateY(-50px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes scaleIn {
    from { 
        transform: scale(0);
        opacity: 0;
    }
    to { 
        transform: scale(1);
        opacity: 1;
    }
}

/* Confetti Animation */
#congratsContent { position: relative; overflow: visible; }
#congratsConfetti {
    position: absolute; top: -30px; left: -30px; right: -30px; bottom: -30px;
    pointer-events: none; overflow: visible; z-index: 1;
}
#congratsIcon, h2, p, button { position: relative; z-index: 2; }
.confetti-piece {
    position: absolute; width: 8px; height: 16px; opacity: 0;
    animation: confetti-fall 1.5s ease-out forwards;
}
@keyframes confetti-fall {
    0% { transform: translate3d(0,-50px,0) rotateZ(0deg); opacity: 1; }
    25% { opacity: 1; }
    100% { transform: translate3d(0,150px,0) rotateZ(720deg); opacity: 0; }
}
    
        /* === MODERN OVERRIDE 2.0.3 === */
        :root {
            --bg-dark: #020617;
            --bg-gradient: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 55%, #000 100%);
            --glass-surface: rgba(15, 23, 42, 0.88);
            --glass-border: rgba(148, 163, 184, 0.15);
            --glass-blur: blur(16px);

            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-soft: rgba(99, 102, 241, 0.1);

            --success: #22c55e;
            --danger: #ef4444;
            --warning: #eab308;
            --info: #0ea5e9;

            --text-main: #f1f5f9;
            --text-muted: #94a3b8;

            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;

            --shadow-card: 0 20px 40px -5px rgba(0, 0, 0, 0.4);
            --shadow-soft: 0 8px 16px -2px rgba(0, 0, 0, 0.3);
        }

        body {
            background-color: var(--bg-dark);
            background-image: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .wrapper {
            padding: 24px 0 60px;
        }

        .topbar {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border-radius: 99px;
            padding: 10px 20px;
            border: 1px solid var(--glass-border);
            margin-bottom: 32px;
            box-shadow: var(--shadow-soft);
        }

        
        .brand-logo {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.5);
            overflow: hidden;
        }
        .brand-logo::before {
            content: "";
            position: absolute;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            top: -20%;
            left: -20%;
        }
        .brand-logo svg {
            width: 24px;
            height: 24px;
            color: white;
            z-index: 1;
        }


        .card {
            background: var(--glass-surface);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-card);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .card-header h2 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        /* Table Styles */
        #goalsTable {
            border-collapse: separate;
            border-spacing: 0 4px; /* Slight separation for rows if desired, or 0 for connected */
        }
        #goalsTable th {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            
            padding: 12px 16px;
        }
        #goalsTable td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        #goalsTable tbody tr:hover td {
            background: rgba(255,255,255,0.02);
        }

        /* Inputs */
        input[type="text"], input[type="number"], textarea, select {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            border-radius: 8px !important;
            color: #fff !important;
            padding: 8px 12px !important;
            transition: all 0.2s;
        }
        input:focus, textarea:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            background: rgba(0, 0, 0, 0.5) !important;
        }

        /* Buttons */
        .btn-primary {
            border-radius: 99px;
            padding: 10px 24px;
            font-weight: 600;
            letter-spacing: 0.02em;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            border: none;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(99, 102, 241, 0.5);
        }

        .type-icon-btn, .status-icon-btn {
            border-radius: 99px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .type-icon-btn:hover, .status-icon-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        /* Weeks and Stats */
        .weeks-card {
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            background: rgba(15, 23, 42, 0.6);
        }

        .week-box {
             border-radius: 12px;
             border: 1px solid rgba(255,255,255,0.05);
             background: rgba(20, 30, 50, 0.6);
        }

        .stat {
            background: linear-gradient(160deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.6));
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .stat-value {
            font-size: 24px;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

    
/* Rating Bar Styles */
.rating-bar-container {
    margin-top: 8px;
    background: rgba(255, 255, 255, 0.1);
    height: 6px;
    border-radius: 99px;
    width: 100%;
    overflow: hidden;
    position: relative;
}
.rating-bar-fill {
    width: 0%;
    height: 100%;
    background: #22c55e;
    border-radius: 99px;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
}


    /* Back to top button */
    
    .back-to-top.show {
        opacity: 1;
        visibility: visible;
    }
    .back-to-top:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
    }
    
.profile-stats-container {
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid var(--glass-border);
}
.profile-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
}
.p-stat {
    background: rgba(255,255,255,0.03);
    padding: 10px 5px;
    border-radius: var(--radius-sm);
    text-align: center;
    border: 1px solid var(--glass-border);
}
.p-stat-label {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}
.p-stat-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--primary);
}



.scroll-to-current:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
}


.back-to-top, .scroll-to-current {
    position: fixed;
    right: 20px;
    width: 50px;
    height: 50px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    z-index: 1000;
    transition: all 0.3s ease;
    opacity: 0;
    visibility: hidden;
}

.back-to-top { bottom: 20px; }
.scroll-to-current { bottom: 20px; } /* Same position as they alternate */

.back-to-top.show, .scroll-to-current.show {
    opacity: 1;
    visibility: visible;
}

.back-to-top:hover, .scroll-to-current:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
}


    /* Border Label Styles - Netflix Style */
    .card, .weeks-card {
        position: relative !important;
        margin-top: 25px !important;
    }
    .card-label {
        position: absolute;
        top: -12px;
        left: 24px;
        background: #6366f1;
        color: #ffffff;
        padding: 4px 16px;
        border-radius: 50px;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        z-index: 10;
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        pointer-events: none;
    }

    
/* Styl dla ikonki zmiany na awatarze */
.user-pill {
    position: relative;
    transition: all 0.3s ease !important;
    cursor: pointer;
}
.user-pill:hover {
    background: rgba(255, 255, 255, 0.08) !important;
    border-color: var(--primary) !important;
    transform: translateY(-1px);
}
.user-avatar {
    position: relative;
    transition: all 0.3s ease;
}
.user-pill:hover .user-avatar {
    transform: rotate(15deg);
}
.user-pill:hover .user-avatar::after {
    content: '⇄';
    position: absolute;
    inset: 0;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
    animation: fadeInScale 0.2s ease-out;
    box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
}
@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.5); }
    to { opacity: 1; transform: scale(1); }
}

</style>
</head>
<body>
<div id="profileOverlay">
<div class="profile-overlay-inner">
<h2>Wybierz profil</h2>
<p class="muted">Każdy profil ma własne cele i tygodnie. Wybierz, dla kogo teraz planujesz.</p>
<div class="profiles-grid-overlay" id="profilesGridOverlay"></div>
<div class="profile-overlay-actions" style="text-align:center; margin-top:20px;">
<button class="btn-outline-light" id="addProfileFromOverlay" type="button">
                + Dodaj nowy profil
            </button>
</div>
</div>
</div>
<div class="wrapper">
<header class="topbar">
<div class="brand">
<div class="brand-logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg></div>
<div class="brand-text">
<h1>SMASH YOUR GOALS</h1>
<span>Skoncentrowany planner celów tygodniowych</span>
</div>
</div>
<div class="topbar-right">
<div class="user-pill">
<div class="user-avatar" id="userAvatar">?</div>
<div class="user-name-wrap">
<span class="user-name" id="accountInfo">Niezalogowano</span>
<span class="user-sub" id="activeProfileLabel">Brak profilu</span>
</div>
</div>
<button class="btn-ghost btn-icon" id="openAuthModal" title="Ustawienia konta" type="button">
<svg fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
</button>
<div class="period-chip">
<label>Okres</label>
<input id="dateFrom" style="min-width: 110px;" type="date"/>
<button class="btn-ghost" id="setNextMonday" style="padding: 4px 10px; font-size: 11px; height: 35px; border-radius: 8px; margin-left: -5px; display: flex; align-items: center; justify-content: center;" title="Ustaw najbliższy poniedziałek" type="button">
<svg fill="none" height="18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" style="color: var(--text-main);" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
<rect height="18" rx="2" ry="2" width="18" x="3" y="4"></rect>
<line x1="16" x2="16" y1="2" y2="6"></line>
<line x1="8" x2="8" y1="2" y2="6"></line>
<line x1="3" x2="21" y1="10" y2="10"></line>
<path d="M12 14l2 2-2 2"></path>
<path d="M8 16h6"></path>
</svg>
</button>
<span style="color:var(--text-muted);">×</span>
<input id="weeksCount" min="1" placeholder="Tyg." style="width: 70px;" type="number"/>
<span style="color:var(--text-muted);">Do:</span>
<strong id="dateToLabel" style="font-size:14px;">—</strong>
<span class="period-tag" id="periodSummary">0 / 0 tyg.</span>
</div>
</div>
</header>
<div id="authModal">
<div class="auth-card">
<button id="closeAuthModal" style="
                position:absolute; right:16px; top:16px;
                background:transparent; border:none; color:#6b7280;
                font-size:24px; cursor:pointer;" type="button">×</button>
<h2 style="margin:0 0 8px;font-size:20px;">Konto i profile</h2>
<p class="muted" style="margin:0 0 20px;">
                Zaloguj się, ustaw pseudonim i zarządzaj profilami.
            </p>
<div id="authFormArea">
<div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
<div>
<label class="muted" style="font-size:12px;display:block;margin-bottom:4px;">Email</label>
<input id="authEmail" placeholder="twoj@email.com" style="width:100%;padding:10px;background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);color:white;border-radius:6px;" type="email"/>
</div>
<div>
<label class="muted" style="font-size:12px;display:block;margin-bottom:4px;">Hasło</label>
<input id="authPassword" placeholder="min. 6 znaków" style="width:100%;padding:10px;background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);color:white;border-radius:6px;" type="password"/>
</div>
</div>
<button class="btn-primary" id="btnLogin" style="width:100%;" type="button">
                    Zaloguj / Zarejestruj
                </button>
</div>
<div id="profileArea" style="margin-top:24px;border-top:1px solid var(--glass-border);padding-top:16px;">
<label class="muted" style="font-size:12px;">Pseudonim / nick konta</label>
<div style="display:flex;gap:8px;margin-top:4px;">
<input id="nicknameInput" placeholder="Twój nick" style="background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);padding:8px;color:white;border-radius:6px;flex:1;" type="text"/>
<button class="btn-ghost" id="saveNickname" style="padding:8px 12px;" type="button">Zapisz</button>
</div>
<div style="margin-top:16px;">
<label class="muted" style="font-size:12px;">Twoje profile</label>
<div class="profiles-grid" id="profilesGrid"></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px;">
<input id="newProfileName" placeholder="Nowy profil (np. Daniel)" style="background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);padding:8px;color:white;border-radius:6px;flex:1;" type="text"/>
<button class="btn-ghost" id="addProfileBtn" type="button">Dodaj</button>
</div>
<button class="btn-primary" id="confirmProfileBtn" style="margin-top:16px;width:100%;" type="button">
                    Ustaw zaznaczony profil (domyślny)
                </button>
</div>

        <div class="profile-stats-container">
            <label class="muted" style="font-size:12px">Statystyki aktywnego profilu</label>
            <div class="profile-stats-grid">
                <div class="p-stat">
                    <div class="p-stat-label">Cele</div>
                    <div class="p-stat-value" id="p-stat-goals">0</div>
                </div>
                <div class="p-stat">
                    <div class="p-stat-label">Kary</div>
                    <div class="p-stat-value" id="p-stat-money">0 zł</div>
                </div>
                <div class="p-stat">
                    <div class="p-stat-label">Tygodnie</div>
                    <div class="p-stat-value" id="p-stat-weeks">0</div>
                </div>
            </div>
        </div>

        <button class="btn-ghost" id="btnLogout" style="margin-top:16px;width:100%;display:none;" type="button">
                Wyloguj się
            </button>
<div id="authStatus" style="margin-top:12px;font-size:13px;color:var(--warning);text-align:center;min-height:20px;"></div>
</div>
</div>
<main class="layout">
<section class="card"><div class="card-label">Cele Profilu</div>

<div style="overflow-x:auto;">
<table id="goalsTable">
<thead>
<tr>
<th style="width:30%;">Cel</th>
<th style="width:25%;">Opis</th>
<th style="width:15%;">Min. / tydz.</th>
<th style="width:15%;">Rodzaj</th>
<th style="width:15%;">Postęp</th>
</tr>
</thead>
<tbody>
<tr>
<td><input placeholder="Np. Trening siłowy" type="text"/></td>
<td><input placeholder="Krótko: co i jak?" type="text"/></td>
<td><input placeholder="Np. 3× / tydz." type="text"/></td>
<td>
<button class="type-icon-btn" data-type="ILOŚĆ" onclick="window.openTypeMenu(event, this)" type="button">
                                ILOŚĆ
                            </button>
</td>
<td>
<button class="status-icon-btn" data-status="W TRAKCIE" title="Zmień status" type="button">
<svg class="icon-spin" fill="none" height="20" stroke="#94a3b8" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M5 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4a2 2 0 0 0 .88 1.56c1.3 1.01 1.97 2.8 1.13 4.42-.13.26-.2.54-.2.82v5.2c0 1.1.9 2 2 2Z"></path><path d="M5 2h14"></path><path d="M5 22h14"></path><path d="M15 2v5.5L21 7.5"></path></svg>
</button>
</td>
</tr>
</tbody>
</table>
</div>
<div class="goals-footer">

<button class="btn-primary" id="addGoalBtn" type="button" title="Dodaj cel" style="width: 45px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; border-radius: 50%;">+</button>
</div>
<div class="weeks-card"><div class="card-label">Tygodnie</div>
<div class="weeks-card-header" style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:16px;">
<div>


</div>
</div>
<div class="weeks-grid" id="weeksGrid"></div>
<p class="muted" style="margin-top:16px;text-align:center;">
                    
                </p>
</div>
</section>
<section class="card"><div class="card-label">Podsumowanie</div>

<div class="stats-grid">
<div class="stat">
<div class="stat-label">% realizacji celów</div>
<div class="stat-value stat-success" id="goalsProgressPercent">0%</div>
<div class="stat-extra">Odsetek celów z wynikiem „POWIODŁO SIĘ”.</div>
</div>
<div class="stat">
<div class="stat-label">% udanych tygodni</div>
<div class="stat-value stat-success" id="weeklySuccess">0%</div>
<div class="stat-extra">Ile tygodni oznaczono jako udane.</div>
</div>
<div class="stat">
<div class="stat-label">Średnia ocena</div>
<div class="stat-value" id="avgRating">0,0 / 10</div>
<div class="stat-extra">Średnia z ocen tygodnia w tym okresie.</div>
</div>
</div>
</section>
</main>
</div>
<div id="penaltyModal">
<div id="penaltyModalInner">
<button id="closePenaltyModal" style="
            position:absolute;right:16px;top:16px;
            background:transparent;border:none;color:#9ca3af;
            font-size:24px;cursor:pointer;">×</button>
<h2 id="penaltyModalTitle" style="margin-top:0;color:var(--danger);">Kara za niepowodzenia</h2>
<p id="penaltyModalMessage" style="font-size:15px;line-height:1.5;"></p>
<p id="penaltyModalTotal" style="font-size:15px;margin:12px 0;white-space:nowrap;"></p>
<p class="muted" id="penaltyModalHint" style="font-size:13px;">Po wysłaniu przelewu możesz zresetować wszystkie kary, aby zacząć od zera.</p>
<div class="penalty-actions" style="display:flex;gap:10px;margin-top:20px;">
<button class="btn-primary" id="resetPenaltyBtn" style="background:var(--warning);color:#000;">Zresetuj karę (wysłano przelew)</button>
<button class="btn-ghost" id="closePenaltyBottomBtn">Zamknij</button>
</div>
</div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs,
        query,
        where,
        deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6L9YFxKsnGXaz4gvfFiJoPlNPO-121qw",
      authDomain: "smash-your-goals-126e1.firebaseapp.com",
      projectId: "smash-your-goals-126e1",
      storageBucket: "smash-your-goals-126e1.firebasestorage.app",
      messagingSenderId: "5.28325368186e+11",
      appId: "1:5.28325368186e+11:web:f16bc010fe0a0d15ca5ec3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const accountInfoEl = document.getElementById('accountInfo');
    const activeProfileLabelEl = document.getElementById('activeProfileLabel');
    const userAvatarEl = document.getElementById('userAvatar');
    const authModal = document.getElementById('authModal');
    const openAuthModalBtn = document.getElementById('openAuthModal');
    const closeAuthModalBtn = document.getElementById('closeAuthModal');

    const profileOverlay = document.getElementById('profileOverlay');
    const profilesGrid = document.getElementById('profilesGrid');
    const profilesGridOverlay = document.getElementById('profilesGridOverlay');
    const addProfileFromOverlayBtn = document.getElementById('addProfileFromOverlay');

    const newProfileNameInput = document.getElementById('newProfileName');
    const confirmProfileBtn = document.getElementById('confirmProfileBtn');

    const emailInput = document.getElementById('authEmail');
    const passInput = document.getElementById('authPassword');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const authStatus = document.getElementById('authStatus');
    const nicknameInput = document.getElementById('nicknameInput');
    const saveNicknameBtn = document.getElementById('saveNickname');
    const addProfileBtn = document.getElementById('addProfileBtn');

    const penaltyModal = document.getElementById('penaltyModal');
    const penaltyModalMessage = document.getElementById('penaltyModalMessage');
    const penaltyModalTotal = document.getElementById('penaltyModalTotal');
    const closePenaltyModalBtn = document.getElementById('closePenaltyModal');
    const closePenaltyBottomBtn = document.getElementById('closePenaltyBottomBtn');
    const resetPenaltyBtn = document.getElementById('resetPenaltyBtn');

    let currentUser = null;
    let activeProfileId = null;
    let selectedProfileIdTemp = null;
    let saveTimeout = null;

async function updateProfileGlobalStats() {
    if (!currentUser || !activeProfileId) {
        document.getElementById('p-stat-goals').textContent = '0';
        document.getElementById('p-stat-money').textContent = '0 zł';
        document.getElementById('p-stat-weeks').textContent = '0';
        return;
    }
    try {
        const goalsQuery = query(collection(db, 'goals'), where('userId', '==', currentUser.uid), where('profileId', '==', activeProfileId));
        const goalsSnap = await getDocs(goalsQuery);
        let done = 0;
        let money = 0;
        goalsSnap.forEach(doc => {
            const data = doc.data();
            if (data.status === 'POWIODŁO SIĘ') done++;
            if (data.penaltyAmount) money += Number(data.penaltyAmount);
        });

        const weeksQuery = query(collection(db, 'weeks'), where('userId', '==', currentUser.uid), where('profileId', '==', activeProfileId));
        const weeksSnap = await getDocs(weeksQuery);
        let goodWeeks = 0;
        weeksSnap.forEach(doc => {
            if (doc.data().success === true) goodWeeks++;
        });

        document.getElementById('p-stat-goals').textContent = done;
        document.getElementById('p-stat-money').textContent = money + ' zł';
        document.getElementById('p-stat-weeks').textContent = goodWeeks;
    } catch (e) {
        console.error("Błąd statystyk:", e);
    }
}


    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getTotalPenalty() {
        let sum = 0;
        document.querySelectorAll('.status-icon-btn').forEach(btn => {
            const v = btn.dataset.penaltyAmount;
            if (v) sum += Number(v);
        });
        return sum;
    }

    function updatePenaltyTotalText() {
        const total = getTotalPenalty();
        penaltyModalTotal.innerHTML =
            `Łączna kara ze wszystkich niepowodzeń: <span class="penalty-amount-highlight">${total} zł</span>.`;
    }

    function clearAllPenaltiesInUI() {
        document.querySelectorAll('.status-icon-btn').forEach(btn => {
            delete btn.dataset.penaltyAmount;
        });
    }

    function closePenaltyModal() {
        penaltyModal.style.display = 'none';
    }

    closePenaltyModalBtn.addEventListener('click', closePenaltyModal);
    closePenaltyBottomBtn.addEventListener('click', closePenaltyModal);
    penaltyModal.addEventListener('click', (e) => {
        if (e.target === penaltyModal) closePenaltyModal();
    });

    resetPenaltyBtn.addEventListener('click', async () => {
        clearAllPenaltiesInUI();
        updatePenaltyTotalText();
        await saveAllData();
        penaltyModalMessage.textContent = 'Kary zostały zresetowane. Zaczynasz od zera.';
    });

    openAuthModalBtn.addEventListener('click', () => { updateProfileGlobalStats();
        authModal.style.display = 'flex';
    });
    closeAuthModalBtn.addEventListener('click', () => {
        authModal.style.display = 'none';
    });
    authModal.addEventListener('click', (e) => {
        if (e.target === authModal) authModal.style.display = 'none';
    });

    function addWeeks(date, weeks) {
        const result = new Date(date);
        result.setDate(result.getDate() + weeks * 7);
        return result;
    }

    function formatDate(date) {
        return date.toLocaleDateString('pl-PL', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    function getDateFromInput(input) {
        if (!input.value) return null;
        const parts = input.value.split('-');
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    
    function updateRatingBar(input) {
        if (!input) return;
        // The input is inside .week-rating. The bar is the next sibling of .week-rating.
        const ratingRow = input.closest('.week-rating');
        if (!ratingRow) return;
        const container = ratingRow.nextElementSibling;

        if (!container || !container.classList.contains('rating-bar-container')) return;

        const bar = container.querySelector('.rating-bar-fill');
        const val = parseInt(input.value);

        if (isNaN(val) || val < 1) {
             bar.style.width = '0%';
             return;
        }

        const pct = Math.min(100, Math.max(0, val * 10));
        bar.style.width = pct + '%';

        // Color logic
        if (val >= 8) {
            bar.style.backgroundColor = '#22c55e'; // Green
        } else if (val >= 5) {
            bar.style.backgroundColor = '#eab308'; // Yellow
        } else {
            bar.style.backgroundColor = '#ef4444'; // Red
        }
    }

    function renderWeeks(startDate, weeksCount) {
  const weeksGrid = document.getElementById("weeksGrid");
  weeksGrid.innerHTML = "";
  if (!startDate || !weeksCount || weeksCount <= 0) return;

  for (let i = 0; i < weeksCount; i++) {
    const weekStart = addWeeks(startDate, i);
    const weekEnd = addWeeks(startDate, i + 1);
    const card = document.createElement("div");
    card.className = "week-card";
    card.innerHTML = `
      <div class="week-row-top">
        <span class="badge-week">Tydzień ${i + 1}</span>
        <span class="week-date">${formatDate(weekStart)} – ${formatDate(new Date(weekEnd.getTime() - 1))}</span>
      </div>
      <div class="week-toggles">
        <button type="button" class="week-btn btn-success" title="Tydzień udany">✓</button>
        <button type="button" class="week-btn btn-fail" title="Tydzień nieudany">✕</button>
      </div>
      <textarea class="week-note" placeholder="Notatka z tygodnia..."></textarea>
      <div class="week-rating">
        <span>Ocena tygodnia</span>
        <input type="number" class="week-rating-input" min="1" max="10" step="1" placeholder="1-10" />
      </div>
      <div class="rating-bar-container"><div class="rating-bar-fill"></div></div>
    `;
    weeksGrid.appendChild(card);
  }

  attachWeekListeners();
  updateStats();

  // AUTO-SCROLL do aktualnego tygodnia
  const today = new Date();
  const cards = weeksGrid.querySelectorAll(".week-card");

  let targetCard = null;
  if (startDate) {
    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
    const diffMs = today.getTime() - startDate.getTime();
    const passedWeeks = diffMs > 0 ? Math.floor(diffMs / msPerWeek) : 0;
    const index = Math.min(Math.max(passedWeeks, 0), cards.length - 1);
            cards[index].classList.add("current-week");
    targetCard = cards[index] || null;   // aktualny tydzień
  } else {
    targetCard = cards[cards.length - 1] || null; // fallback: ostatni tydzień
  }

  if (targetCard) {
    /* Scroll disabled */
  }
}


    function attachWeekListeners() {
        const updateCardStyle = (card, successBtn, failBtn) => {
            card.classList.remove('week-success', 'week-fail');
            if (successBtn.classList.contains('active')) {
                card.classList.add('week-success');
            } else if (failBtn.classList.contains('active')) {
                card.classList.add('week-fail');
            }
        };

        document.querySelectorAll('.week-toggles').forEach(toggleGroup => {
            const successBtn = toggleGroup.querySelector('.btn-success');
            const failBtn = toggleGroup.querySelector('.btn-fail');
            const card = toggleGroup.closest('.week-card');

            successBtn.onclick = () => {
                const wasActive = successBtn.classList.contains('active');
                successBtn.classList.remove('active');
                failBtn.classList.remove('active');

                if (!wasActive) {
                    successBtn.classList.add('active');
                }

                updateCardStyle(card, successBtn, failBtn);
                updateStats();
                scheduleSave();
            };

            failBtn.onclick = () => {
                const wasActive = failBtn.classList.contains('active');
                successBtn.classList.remove('active');
                failBtn.classList.remove('active');

                if (!wasActive) {
                    failBtn.classList.add('active');
                }

                updateCardStyle(card, successBtn, failBtn);
                updateStats();
                scheduleSave();
            };
        });

        document.querySelectorAll('.week-rating-input').forEach(inp => {
            inp.addEventListener('input', (e) => { updateRatingBar(e.target); updateStats(); scheduleSave(); });
        });
        document.querySelectorAll('.week-note').forEach(inp => {
            inp.addEventListener('input', () => { scheduleSave(); });
        });
    }

    function updateStats() {
        const successBtns = document.querySelectorAll('.btn-success');
        const ratingInputs = document.querySelectorAll('.week-rating-input');

        let successCount = 0;
        successBtns.forEach(btn => { if (btn.classList.contains('active')) successCount++; });
        const totalWeeks = successBtns.length;
        
        const weeklySuccessEl = document.getElementById('weeklySuccess');
        weeklySuccessEl.textContent = totalWeeks > 0
            ? Math.round((successCount / totalWeeks) * 100) + '%'
            : '0%';

        let sum = 0, count = 0;
        ratingInputs.forEach(inp => {
            const v = parseFloat((inp.value || '').toString().replace(',', '.'));
            if (!isNaN(v) && v >= 1 && v <= 10) { sum += v; count++; }
        });
        const avgEl = document.getElementById('avgRating');
        avgEl.textContent = count > 0
            ? (sum / count).toFixed(1).replace('.', ',') + ' / 10'
            : '0,0 / 10';

        const dateFromInput = document.getElementById('dateFrom');
        const startDate = getDateFromInput(dateFromInput);
        const weeksInput = document.getElementById('weeksCount');
        const weeksCount = parseInt(weeksInput.value, 10) || 0;
        const tag = document.getElementById('periodSummary');

        if (startDate && weeksCount > 0) {
            const today = new Date();
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const diffMs = today.getTime() - startDate.getTime();
            const passedWeeks = diffMs > 0 ? Math.floor(diffMs / msPerWeek) : 0;
            const clampedPassed = Math.min(Math.max(passedWeeks, 0), weeksCount);
            tag.textContent = clampedPassed + ' / ' + weeksCount + ' tyg.';
        } else {
            tag.textContent = '0 / 0 tyg.';
        }

        updateGoalsProgress();
    }

    function updatePeriod() {
        const dateFromInput = document.getElementById('dateFrom');
        const weeksInput = document.getElementById('weeksCount');
        const startDate = getDateFromInput(dateFromInput);
        const weeksCount = parseInt(weeksInput.value, 10);
        const dateToLabel = document.getElementById('dateToLabel');

        if (startDate && weeksCount && weeksCount > 0) {
            const endDate = addWeeks(startDate, weeksCount);
            const lastDay = new Date(endDate.getTime() - 1);
            dateToLabel.textContent = formatDate(lastDay);

            const existingCards = document.querySelectorAll('#weeksGrid .week-card').length;
            if (existingCards === 0) {
                renderWeeks(startDate, weeksCount);
            }
        } else {
            dateToLabel.textContent = '—';
            document.getElementById('weeksGrid').innerHTML = '';
        }
        updateStats();
        scheduleSave();
    }

    document.getElementById('dateFrom').addEventListener('change', updatePeriod);
    document.getElementById('weeksCount').addEventListener('input', updatePeriod);

    function getStatusIcon(status) {
        if (status === 'W TRAKCIE') {
            return `<div class=\"loading-dots\"><div></div><div></div><div></div></div>`;
        } else if (status === 'POWIODŁO SIĘ') {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
        } else if (status === 'NIE POWIODŁO') {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
        } else if (status === 'POŁOWICZNIE POWIODŁO') {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
        }
        return '';
    }

    window.openTypeMenu = function(e, btn) {
        e.stopPropagation();
        const existing = document.querySelector('.status-dropdown');
        if (existing) existing.remove();

        const options = [
            'ILOŚĆ', 'DYSTANS', 'CZAS TRWANIA', 'WAGA',
            'GODZINA', 'CIĘŻAR', 'POWTÓRZENIA', 'INNE'
        ];

        const menu = document.createElement('div');
        menu.className = 'status-dropdown';
        const rect = btn.getBoundingClientRect();
        menu.style.top = (window.scrollY + rect.bottom + 5) + 'px';
        menu.style.left = (window.scrollX + rect.left) + 'px';
        menu.style.minWidth = rect.width + 'px';

        options.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'status-dropdown-item';
            item.textContent = opt;
            item.onclick = () => {
                btn.dataset.type = opt;
                btn.textContent = opt;
                scheduleSave();
                menu.remove();
            };
            menu.appendChild(item);
        });
        document.body.appendChild(menu);

        const closeHandler = (evt) => {
            if (!menu.contains(evt.target)) {
                menu.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
    };

    function openStatusMenu(e, btn) {
        e.stopPropagation();
        const existing = document.querySelector('.status-dropdown');
        if (existing) existing.remove();

        const options = [
            { label: 'W TRAKCIE', val: 'W TRAKCIE' },
            { label: 'POWIODŁO SIĘ', val: 'POWIODŁO SIĘ' },
            { label: 'POŁOWICZNIE', val: 'POŁOWICZNIE POWIODŁO' },
            { label: 'NIE POWIODŁO', val: 'NIE POWIODŁO' }
        ];

        const menu = document.createElement('div');
        menu.className = 'status-dropdown';
        const rect = btn.getBoundingClientRect();
        menu.style.top = (window.scrollY + rect.bottom + 5) + 'px';
        menu.style.left = (window.scrollX + rect.left) + 'px';

        options.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'status-dropdown-item';
            item.innerHTML = getStatusIcon(opt.val) + ' ' + opt.label;
            item.onclick = () => {
                btn.dataset.status = opt.val;

                const row = btn.closest('tr');
                if (row) {
                    row.classList.remove('goal-success', 'goal-fail', 'goal-partial');
                    if (opt.val === 'POWIODŁO SIĘ') {
                        row.classList.add('goal-success');
                        showCongratulations();
                    }
                    else if (opt.val === 'NIE POWIODŁO') row.classList.add('goal-fail');
                    else if (opt.val === 'POŁOWICZNIE POWIODŁO') row.classList.add('goal-partial');
                }
                btn.innerHTML = getStatusIcon(opt.val);

                if (opt.val === 'NIE POWIODŁO') {
                     if (!btn.dataset.penaltyAmount) {
                        const amount = getRandomInt(1, 25);
                        btn.dataset.penaltyAmount = String(amount);
                        if(typeof penaltyModalMessage !== 'undefined') {
                            penaltyModalMessage.innerHTML =
                                `Za ten cel wylosowano <span class="penalty-amount-highlight">${amount} zł</span> kary.`;
                            updatePenaltyTotalText();
                            penaltyModal.style.display = 'flex';
                        }
                    } else {
                        const amount = Number(btn.dataset.penaltyAmount);
                         if(typeof penaltyModalMessage !== 'undefined') {
                            penaltyModalMessage.innerHTML =
                                `Ten cel ma już przypisaną karę <span class="penalty-amount-highlight">${amount} zł</span>.`;
                            updatePenaltyTotalText();
                            penaltyModal.style.display = 'flex';
                        }
                    }
                }
                updateGoalsProgress();
                scheduleSave();
                menu.remove();
            };
            menu.appendChild(item);
        });
        document.body.appendChild(menu);

        const closeHandler = (evt) => {
            if (!menu.contains(evt.target)) {
                menu.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }

    function attachGoalListeners() {
        document.querySelectorAll('.status-icon-btn').forEach(btn => {
            btn.onclick = function(e) {
                openStatusMenu(e, this);
            };
        });
    }

    document.getElementById('addGoalBtn').addEventListener('click', () => {
        const table = document.getElementById('goalsTable').getElementsByTagName('tbody')[0];
        const row = table.insertRow(-1);
        const cells = [];
        for (let i = 0; i < 5; i++) cells.push(row.insertCell(i));

        cells[0].style.position = 'relative';
        cells[0].innerHTML = `
            <button type="button" class="goal-delete-btn" onclick="window.deleteGoal(${table.rows.length - 1})" title="Usuń cel">×</button>
            <input type="text" placeholder="Np. Trening siłowy">
        `;
        cells[1].innerHTML = '<input type="text" placeholder="Krótko: co i jak?">';
        cells[2].innerHTML = '<input type="text" placeholder="Np. 3× / tydz.">';
        cells[3].innerHTML = `
            <button type="button" class="type-icon-btn" data-type="ILOŚĆ" onclick="window.openTypeMenu(event, this)">
                ILOŚĆ
            </button>`;
        cells[4].innerHTML = `
            <button type="button" class="status-icon-btn" data-status="W TRAKCIE" title="Zmień status">
                ${getStatusIcon('W TRAKCIE')}
            </button>`;

        attachGoalListeners();
        updateGoalsProgress();
        scheduleSave();
    });

    function updateGoalsProgress() {
        const btns = document.querySelectorAll('.status-icon-btn');
        const total = btns.length;
        const out = document.getElementById('goalsProgressPercent');
        if (!out) return;
        if (total === 0) {
            out.textContent = '0%';
            return;
        }
        let succeeded = 0;
        btns.forEach(btn => {
            if (btn.dataset.status === 'POWIODŁO SIĘ') succeeded++;
        });
        out.textContent = Math.round((succeeded / total) * 100) + '%';
    }

    attachGoalListeners();

    btnLogin.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        const password = passInput.value.trim();
        if (!email || !password) {
            authStatus.textContent = 'Podaj email i hasło.';
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
            if (err.code === 'auth/user-not-found') {
                await createUserWithEmailAndPassword(auth, email, password);
            } else {
                authStatus.textContent = 'Błąd logowania: ' + err.code;
            }
        }
    });

    btnLogout.addEventListener('click', () => {
        signOut(auth);
    });

    addProfileBtn.addEventListener('click', async () => {
        if (!currentUser) {
            authStatus.textContent = 'Zaloguj się, aby dodać profil.';
            return;
        }
        const name = newProfileNameInput.value.trim();
        if (!name) {
            authStatus.textContent = 'Podaj nazwę profilu.';
            return;
        }
        const uid = currentUser.uid;
        const profilesCol = collection(db, 'profiles');
        const docRef = doc(profilesCol);
        await setDoc(docRef, { userId: uid, name });
        newProfileNameInput.value = '';
        await loadProfiles(uid, docRef.id);
        authStatus.textContent = 'Dodano profil: ' + name;
    });

    addProfileFromOverlayBtn.addEventListener('click', () => {
        authModal.style.display = 'flex';
        profileOverlay.style.display = 'none';
    });

    confirmProfileBtn.addEventListener('click', async () => {
        if (!currentUser) {
            authStatus.textContent = 'Zaloguj się, aby ustawić profil.';
            return;
        }

        if (activeProfileId) {
            await saveAllData();
        }

        const uid = currentUser.uid;
        const chosenId = selectedProfileIdTemp || null;
        activeProfileId = chosenId;

        await setDoc(
            doc(db, 'users', uid),
            { activeProfileId: chosenId, defaultProfileId: chosenId },
            { merge: true }
        );

        if (chosenId) {
            const tile = document.querySelector(`.profile-tile[data-id="${chosenId}"]`);
            const name = tile ? tile.getAttribute('data-name') : '';
            activeProfileLabelEl.textContent = 'Aktywny profil: ' + name;
            authStatus.textContent = 'Profil ustawiony jako domyślny: ' + name;
        } else {
            activeProfileLabelEl.textContent = 'Brak profilu';
            authStatus.textContent = 'Wyłączono profil.';
        }

        profileOverlay.style.display = 'none';
        clearPlanner();
        await loadAllData();
    });

    saveNicknameBtn.addEventListener('click', async () => {
        if (!currentUser) {
            authStatus.textContent = 'Zaloguj się, aby zapisać nick.';
            return;
        }
        const nick = nicknameInput.value.trim();
        const uid = currentUser.uid;
        await setDoc(
            doc(db, 'users', uid),
            { nickname: nick },
            { merge: true }
        );
        authStatus.textContent = 'Nick zapisany.';
        accountInfoEl.textContent = nick ? nick : 'Zalogowano';
        userAvatarEl.textContent = nick ? nick[0].toUpperCase() : '?';
    });
// Szybkie przełączanie profili po kliknięciu w awatar
if (userAvatarEl && userAvatarEl.parentElement) {
    userAvatarEl.parentElement.title = 'Kliknij, aby szybko zmienić profil';
    userAvatarEl.parentElement.addEventListener('click', async () => {
        if (!currentUser) return;
        try {
            const profilesSnap = await getDocs(query(collection(db, "profiles"), where("userId", "==", currentUser.uid)));
            const profiles = [];
            profilesSnap.forEach(d => profiles.push({ id: d.id, ...d.data() }));

            if (profiles.length < 2) {
                authStatus.textContent = "Dodaj więcej profilów, aby móc się przełączać.";
                return;
            }

            const currentIndex = profiles.findIndex(p => p.id === activeProfileId);
            const nextIndex = (currentIndex + 1) % profiles.length;
            const nextProfile = profiles[nextIndex];

            if (activeProfileId) await saveAllData();

            activeProfileId = nextProfile.id;
            await setDoc(doc(db, "users", currentUser.uid), { 
                activeProfileId: nextProfile.id,
                defaultProfileId: nextProfile.id 
            }, { merge: true });

            activeProfileLabelEl.textContent = `Aktywny profil: ${nextProfile.name}`;
            userAvatarEl.textContent = nextProfile.name[0].toUpperCase();
            authStatus.textContent = `Przełączono na profil: ${nextProfile.name}`;

            clearPlanner();
            await loadAllData();
            updateProfileGlobalStats();
        } catch (err) {
            console.error("Błąd przełączania:", err);
        }
    });
}


    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
            btnLogout.style.display = 'inline-block';
            btnLogin.textContent = 'Zmień konto';

            const settingsSnap = await getDoc(doc(db, 'users', user.uid));
            const data = settingsSnap.exists() ? settingsSnap.data() : {};
            const nickname = data.nickname || '';
            const defaultProfileId = data.defaultProfileId || null;

            nicknameInput.value = nickname;
            activeProfileId = data.activeProfileId || defaultProfileId || null;
            selectedProfileIdTemp = activeProfileId;

            authStatus.textContent = 'Zalogowano';
            accountInfoEl.textContent = nickname ? nickname : 'Zalogowano';
            userAvatarEl.textContent = nickname ? nickname[0].toUpperCase() : '?';

            await loadProfiles(user.uid, activeProfileId);

            const hasProfiles = !!profilesGridOverlay.querySelector('.profile-tile');
            if (hasProfiles && !activeProfileId) {
                profileOverlay.style.display = 'flex';
            }

            await loadAllData();
        } else {
            authStatus.textContent = 'Nie zalogowano.';
            btnLogout.style.display = 'none';
            btnLogin.textContent = 'Zaloguj / Zarejestruj';
            accountInfoEl.textContent = 'Niezalogowano';
            userAvatarEl.textContent = '?';
            activeProfileLabelEl.textContent = 'Brak profilu';
            activeProfileId = null;
            selectedProfileIdTemp = null;
            profilesGrid.innerHTML = '';
            profilesGridOverlay.innerHTML = '';
            profileOverlay.style.display = 'none';
            clearPlanner();
        }
    });

    function createProfileTile(id, name, isActive, isOverlay) {
        const tile = document.createElement('div');
        tile.className = 'profile-tile' + (isOverlay ? ' overlay' : '') + (isActive ? ' active' : '');
        tile.setAttribute('data-id', id);
        tile.setAttribute('data-name', name);

        const initials = name.trim()[0]?.toUpperCase() || '?';

        tile.innerHTML = `
            <button type="button" class="profile-delete" title="Usuń profil">&times;</button>
            <div class="profile-avatar${isOverlay ? ' overlay' : ''}">${initials}</div>
            <div class="profile-name${isOverlay ? ' overlay' : ''}">${name}</div>
        `;

        tile.addEventListener('click', async (e) => {
            if (e.target.classList.contains('profile-delete')) return;
            if (!currentUser) return;

            if (activeProfileId) {
                await saveAllData();
            }

            const uid = currentUser.uid;
            activeProfileId = id; updateProfileGlobalStats();
            selectedProfileIdTemp = id;

            await setDoc(
                doc(db, 'users', uid),
                { activeProfileId: id, defaultProfileId: id },
                { merge: true }
            );

            document.querySelectorAll('.profile-tile').forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`.profile-tile[data-id="${id}"]`).forEach(t => t.classList.add('active'));

            activeProfileLabelEl.textContent = 'Aktywny profil: ' + name;
            authStatus.textContent = 'Profil ustawiony: ' + name;

            profileOverlay.style.display = 'none';
            clearPlanner();
            await loadAllData();
        });

        const deleteBtn = tile.querySelector('.profile-delete');
        deleteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!currentUser) return;
            if (!confirm('Na pewno usunąć ten profil? Spowoduje to usunięcie jego celów i tygodni.')) return;

            const uid = currentUser.uid;

            await deleteDoc(doc(db, 'profiles', id));

            const goalsSnap = await getDocs(
                query(collection(db, 'goals'),
                    where('userId', '==', uid),
                    where('profileId', '==', id))
            );
            for (const g of goalsSnap.docs) await deleteDoc(g.ref);

            const weeksSnap = await getDocs(
                query(collection(db, 'weeks'),
                    where('userId', '==', uid),
                    where('profileId', '==', id))
            );
            for (const w of weeksSnap.docs) await deleteDoc(w.ref);

            if (activeProfileId === id) activeProfileId = null;
            if (selectedProfileIdTemp === id) selectedProfileIdTemp = null;

            const userDocRef = doc(db, 'users', uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const uData = userDoc.data();
                const upd = {};
                if (uData.activeProfileId === id) upd.activeProfileId = null;
                if (uData.defaultProfileId === id) upd.defaultProfileId = null;
                if (Object.keys(upd).length) await setDoc(userDocRef, upd, { merge:true });
            }

            await loadProfiles(uid, activeProfileId);
            await loadAllData();
            authStatus.textContent = 'Profil usunięty.';
        });

        return tile;
    }

    async function loadProfiles(uid, preferProfileId = null) {
        const profilesSnap = await getDocs(
            query(collection(db, 'profiles'), where('userId', '==', uid))
        );
        const profiles = [];
        profilesSnap.forEach(d => profiles.push({ id: d.id, ...d.data() }));

        profilesGrid.innerHTML = '';
        profilesGridOverlay.innerHTML = '';

        if (profiles.length === 0) {
            profilesGrid.innerHTML = '<p style="font-size:11px;color:#9ca3af;margin:0;">Brak profili – dodaj nowy.</p>';
            activeProfileLabelEl.textContent = 'Brak profilu';
            activeProfileId = null;
            selectedProfileIdTemp = null;
            profileOverlay.style.display = 'none';
            return;
        }

        profiles.forEach(p => {
            const isActive = preferProfileId && p.id === preferProfileId;
            const tilePanel = createProfileTile(p.id, p.name, isActive, false);
            const tileOverlay = createProfileTile(p.id, p.name, isActive, true);
            profilesGrid.appendChild(tilePanel);
            profilesGridOverlay.appendChild(tileOverlay);
        });

        if (preferProfileId && profiles.some(p => p.id === preferProfileId)) {
            activeProfileId = preferProfileId;
            selectedProfileIdTemp = preferProfileId;
            const tile = document.querySelector(`.profile-tile[data-id="${preferProfileId}"]`);
            if (tile) {
                const n = tile.getAttribute('data-name');
                activeProfileLabelEl.textContent = 'Aktywny profil: ' + n;
            }
        } else {
            activeProfileId = null;
            selectedProfileIdTemp = null;
            activeProfileLabelEl.textContent = 'Brak profilu';
        }
    }

    window.renderGoalsTable = function(goals) {
        const tbody = document.getElementById('goalsTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (!goals || goals.length === 0) {
            const row = tbody.insertRow(-1);
            row.innerHTML = `
                <td style="position:relative">
                    <input type="text" placeholder="Np. Trening siłowy">
                </td>
                <td><input type="text" placeholder="Krótko: co i jak?"></td>
                <td><input type="text" placeholder="Np. 3× / tydz."></td>
                <td>
                    <button type="button" class="type-icon-btn" data-type="ILOŚĆ" onclick="window.openTypeMenu(event, this)">
                        ILOŚĆ
                    </button>
                </td>
                <td>
                    <button type="button" class="status-icon-btn" data-status="W TRAKCIE" title="Zmień status">
                        ${getStatusIcon('W TRAKCIE')}
                    </button>
                </td>
            `;
        } else {
            goals.forEach((g, index) => {
                const status = g.status || 'W TRAKCIE';
                const row = tbody.insertRow(-1);
                if (status === 'POWIODŁO SIĘ') row.classList.add('goal-success');
                else if (status === 'NIE POWIODŁO') row.classList.add('goal-fail');
                else if (status === 'POŁOWICZNIE POWIODŁO') row.classList.add('goal-partial');

                row.innerHTML = `
                    <td style="position:relative">
                        <button type="button" class="goal-delete-btn" onclick="window.deleteGoal(${index})" title="Usuń cel">×</button>
                        <input type="text" value="${g.title || ''}" placeholder="Np. Trening siłowy">
                    </td>
                    <td><input type="text" value="${g.description || ''}" placeholder="Krótko: co i jak?"></td>
                    <td><input type="text" value="${g.minPerWeek || ''}" placeholder="Np. 3× / tydz."></td>
                    <td>
                        <button type="button" class="type-icon-btn" data-type="${g.type || 'ILOŚĆ'}" onclick="window.openTypeMenu(event, this)">
                            ${g.type || 'ILOŚĆ'}
                        </button>
                    </td>
                    <td>
                        <button type="button" class="status-icon-btn" data-status="${status}" title="Zmień status">
                            ${getStatusIcon(status)}
                        </button>
                    </td>
                `;
            });
        }
        attachGoalListeners();
        updateStats();
    };

    window.deleteGoal = async function(index) {
        if (!confirm("Czy na pewno chcesz usunąć ten cel?")) return;

        const currentGoals = getGoalsFromUI();
        currentGoals.splice(index, 1);
        window.renderGoalsTable(currentGoals);
        await saveAllData();
    };

    function clearPlanner() {
        document.getElementById('dateFrom').value = '';
        document.getElementById('weeksCount').value = '';
        document.getElementById('dateToLabel').textContent = '—';
        document.getElementById('periodSummary').textContent = '0 / 0 tyg.';
        document.getElementById('weeksGrid').innerHTML = '';
        window.renderGoalsTable([]);
    }

    function getGoalsFromUI() {
        const rows = document.querySelectorAll('#goalsTable tbody tr');
        const goals = [];
        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            const btn = cells[4].querySelector('.status-icon-btn');
            goals.push({
                order: index,
                title: cells[0].querySelector('input').value || '',
                description: cells[1].querySelector('input').value || '',
                minPerWeek: cells[2].querySelector('input').value || '',
                type: (cells[3].querySelector('.type-icon-btn') ? cells[3].querySelector('.type-icon-btn').dataset.type : 'ILOŚĆ'),
                status: btn.dataset.status || 'W TRAKCIE',
                penaltyAmount: btn.dataset.penaltyAmount
                    ? Number(btn.dataset.penaltyAmount)
                    : null,
            });
        });
        return goals;
    }

    function getWeeksFromUI() {
        const cards = document.querySelectorAll('#weeksGrid .week-card');
        const weeks = [];
        cards.forEach((card, index) => {
            const successBtn = card.querySelector('.btn-success');
            const failBtn = card.querySelector('.btn-fail');

            weeks.push({
                index,
                label: card.querySelector('.badge-week').textContent,
                dateLabel: card.querySelector('.week-date').textContent,
                success: successBtn.classList.contains('active'),
                fail: failBtn.classList.contains('active'),
                note: card.querySelector('.week-note').value || '',
                rating: card.querySelector('.week-rating-input').value || '',
            });
        });
        return weeks;
    }

        async function saveAllData() {
        if (!currentUser || !activeProfileId) return;
        const uid = currentUser.uid;

        const dateFromInput = document.getElementById('dateFrom');
        const weeksInput = document.getElementById('weeksCount');
        const profileDocRef = doc(db, 'profiles', activeProfileId);

        // Zapis ustawień okresu
        await setDoc(profileDocRef, {
            dateFrom: dateFromInput.value || "",
            weeksCount: weeksInput.value ? Number(weeksInput.value) : 0
        }, { merge: true });

        const goals = getGoalsFromUI();
        const weeks = getWeeksFromUI();

        const goalsCol = collection(db, 'goals');
        const weeksCol = collection(db, 'weeks');

        // Zapis celów (używamy stałych ID na podstawie kolejności)
        for (const g of goals) {
            const gid = `${uid}_${activeProfileId}_goal_${g.order}`;
            await setDoc(doc(goalsCol, gid), { userId: uid, profileId: activeProfileId, ...g });
        }

        // Zapis tygodni (używamy stałych ID na podstawie indeksu)
        for (const w of weeks) {
            const wid = `${uid}_${activeProfileId}_week_${w.index}`;
            await setDoc(doc(weeksCol, wid), { userId: uid, profileId: activeProfileId, ...w });
        }

        authStatus.textContent = 'Synchronizacja zakończona pomyślnie.';
        setTimeout(() => { authStatus.textContent = ''; }, 3000);
    }

        async function loadAllData() {
        if (!currentUser || !activeProfileId) {
            clearPlanner();
            return;
        }
        const uid = currentUser.uid;

        // 1. Ładowanie ustawień profilu
        const profileSnap = await getDoc(doc(db, 'profiles', activeProfileId));
        if (profileSnap.exists()) {
            const pData = profileSnap.data();
            if (pData.dateFrom) document.getElementById('dateFrom').value = pData.dateFrom;
            if (pData.weeksCount) document.getElementById('weeksCount').value = pData.weeksCount;
        }

        // 2. Renderowanie pustej siatki na podstawie ustawień
        const startD = getDateFromInput(document.getElementById('dateFrom'));
        const wCount = parseInt(document.getElementById('weeksCount').value) || 0;
        renderWeeks(startD, wCount);
        updatePeriod();

        // 3. Ładowanie celów
        const goalsSnap = await getDocs(query(collection(db, 'goals'), 
            where('userId', '==', uid), where('profileId', '==', activeProfileId)));
        const goals = [];
        goalsSnap.forEach(d => goals.push(d.data()));
        goals.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
        window.renderGoalsTable(goals);

        // 4. Ładowanie danych tygodni i wypełnianie kart
        const weeksSnap = await getDocs(query(collection(db, 'weeks'), 
            where('userId', '==', uid), where('profileId', '==', activeProfileId)));

        const weeksGrid = document.getElementById('weeksGrid');
        const weekCards = weeksGrid.querySelectorAll('.week-card');

        weeksSnap.forEach(docSnap => {
            const w = docSnap.data();
            if (w.index < weekCards.length) {
                const card = weekCards[w.index];
                const successBtn = card.querySelector('.btn-success');
                const failBtn = card.querySelector('.btn-fail');
                const noteArea = card.querySelector('.week-note');
                const ratingInput = card.querySelector('.week-rating-input');

                if (w.success) {
                    successBtn.classList.add('active');
                    card.classList.add('week-success');
                } else if (w.fail) {
                    failBtn.classList.add('active');
                    card.classList.add('week-fail');
                }
                if (w.note) noteArea.value = w.note;
                if (w.rating) { 
                    ratingInput.value = w.rating; 
                    updateRatingBar(ratingInput); 
                }
            }
        });

        updateStats();
    }

    function scheduleSave() {
        if (!currentUser || !activeProfileId) return;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveAllData, 300);
    }

    ['dateFrom', 'weeksCount'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', scheduleSave);
    });

    document.addEventListener('input', (e) => {
        if (e.target.closest('#goalsTable') || e.target.closest('#weeksGrid')) {
            scheduleSave();
        }
    });

    const congratsModal = document.getElementById('congratsModal');
    const closeCongratsBtn = document.getElementById('closeCongratsBtn');

    function launchConfetti() {
        const c = document.getElementById('congratsConfetti');
        if (!c) return;
        c.innerHTML = '';
        const colors = ['#f97316', '#22c55e', '#3b82f6', '#eab308', '#ec4899', '#a855f7'];
        for (let i = 0; i < 60; i++) {
            const p = document.createElement('div');
            p.className = 'confetti-piece';
            p.style.left = Math.random() * 100 + '%';
            p.style.top = -Math.random() * 20 + '%';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.animationDelay = (Math.random() * 1) + 's';
            p.style.animationDuration = (1 + Math.random()) + 's';
            c.appendChild(p);
        }
        setTimeout(() => { if(c) c.innerHTML = ''; }, 2500);
    }

    function showCongratulations() {
        launchConfetti();
        congratsModal.style.display = 'block';
    }

    closeCongratsBtn.onclick = function() {
        congratsModal.style.display = 'none';
    };

    congratsModal.onclick = function(event) {
        if (event.target === congratsModal) {
            congratsModal.style.display = 'none';
        }
    };

    // Przycisk ustawiania najbliższego poniedziałku
    document.getElementById('setNextMonday').addEventListener('click', () => {
        const today = new Date();
        const day = today.getDay(); // 0 (Nd) do 6 (So)
        // Jeśli jest poniedziałek (1), to chcemy następny poniedziałek (+7 dni).
        // W przeciwnym razie obliczamy ile dni do najbliższego poniedziałku.
        const diff = (day === 1) ? 7 : (day === 0 ? 1 : 8 - day);
        const nextMonday = new Date(today);
        nextMonday.setDate(today.getDate() + diff);

        const yyyy = nextMonday.getFullYear();
        const mm = String(nextMonday.getMonth() + 1).padStart(2, '0');
        const dd = String(nextMonday.getDate()).padStart(2, '0');

        const input = document.getElementById('dateFrom');
        input.value = `${yyyy}-${mm}-${dd}`;

        // Wywołanie aktualizacji okresu
        const event = new Event('change');
        input.dispatchEvent(event);
    });


    document.getElementById('scrollToCurrentBtn').addEventListener('click', () => {
        const currentWeekCard = document.querySelector('.week-card.current-week');
        if (currentWeekCard) {
            currentWeekCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            // If no current week, scroll to the weeks grid container
            const weeksGrid = document.getElementById('weeksGrid');
            if (weeksGrid) weeksGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });


    const backToTopBtn = document.getElementById('backToTop') || document.querySelector('.back-to-top');
    const scrollDownBtn = document.getElementById('scrollToCurrentBtn');

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            // Far down - show Up arrow, hide Down arrow
            if (backToTopBtn) backToTopBtn.classList.add('show');
            if (scrollDownBtn) scrollDownBtn.classList.remove('show');
        } else {
            // At the top - show Down arrow, hide Up arrow
            if (backToTopBtn) backToTopBtn.classList.remove('show');
            if (scrollDownBtn) scrollDownBtn.classList.add('show');
        }
    });

    if (backToTopBtn) {
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    if (scrollDownBtn) {
        scrollDownBtn.addEventListener('click', () => {
            const currentWeekCard = document.querySelector('.week-card.current-week');
            if (currentWeekCard) {
                currentWeekCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                const weeksGrid = document.getElementById('weeksGrid');
                if (weeksGrid) weeksGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }


window.addEventListener('beforeunload', () => {
    if (saveTimeout) {
        clearTimeout(saveTimeout);
        saveAllData();
    }
});

</script>
<!-- Congratulations Modal -->
<div id="congratsModal">
<div id="congratsContent">
<div id="congratsConfetti"></div>
<div id="congratsIcon">🎉</div>
<h2>Gratulacje!</h2>
<p>Świetna robota! Udało Ci się osiągnąć cel!</p>
<button id="closeCongratsBtn">Zamknij</button>
</div>
</div>
<button class="back-to-top" id="backToTopBtn" title="Powrót na górę"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button><script>
// Back to top button
const backToTopBtn = document.getElementById('backToTopBtn');

// Show/hide button on scroll
window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
        backToTopBtn.classList.add('show');
    } else {
        backToTopBtn.classList.remove('show');
    }
});

// Scroll to top on click
backToTopBtn.addEventListener('click', () => {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
});

    document.getElementById('scrollToCurrentBtn').addEventListener('click', () => {
        const currentWeekCard = document.querySelector('.week-card.current-week');
        if (currentWeekCard) {
            currentWeekCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            // If no current week, scroll to the weeks grid container
            const weeksGrid = document.getElementById('weeksGrid');
            if (weeksGrid) weeksGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });


    const backToTopBtn = document.getElementById('backToTop') || document.querySelector('.back-to-top');
    const scrollDownBtn = document.getElementById('scrollToCurrentBtn');

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            // Far down - show Up arrow, hide Down arrow
            if (backToTopBtn) backToTopBtn.classList.add('show');
            if (scrollDownBtn) scrollDownBtn.classList.remove('show');
        } else {
            // At the top - show Down arrow, hide Up arrow
            if (backToTopBtn) backToTopBtn.classList.remove('show');
            if (scrollDownBtn) scrollDownBtn.classList.add('show');
        }
    });

    if (backToTopBtn) {
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    if (scrollDownBtn) {
        scrollDownBtn.addEventListener('click', () => {
            const currentWeekCard = document.querySelector('.week-card.current-week');
            if (currentWeekCard) {
                currentWeekCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                const weeksGrid = document.getElementById('weeksGrid');
                if (weeksGrid) weeksGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }


window.addEventListener('beforeunload', () => {
    if (saveTimeout) {
        clearTimeout(saveTimeout);
        saveAllData();
    }
});

</script>

<button class="scroll-to-current show" id="scrollToCurrentBtn" title="Do aktualnego tygodnia">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M7 10l5 5 5-5"/>
    </svg>
</button>


</body>
</html>
